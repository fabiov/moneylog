<?php
$total = 0;
$dataChart = array();

$this->bindBalance('.balance');
?>
<?php echo $this->pageHeader('Conti'); ?>
<div class="row">
    <?php if ($rows): ?>
    <div class="col-lg-9 col-md-12">
        <div class="panel panel-default">
        <div class="panel-heading">
            Lista conti
        </div>
        <div class="panel-body table-responsive">
            <table class="table table-striped table-bordered table-hover" id="my-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Includi nel riepilogo</th>
                        <th class="text-right">Saldo</th>
                        <th class="text-right">Operazioni</th>
                    </tr>
                </thead>
                <tbody>
                <?php foreach ($rows as $row) : ?>
                    <?php
                    if ($row['total'] > 0) {
                        $dataChart[] = array($row['name'], (float) $row['total']);
                    }
                    $total += $row['total'];
                    ?>
                    <tr>
                        <td class="name"><?php echo $this->escapeHtml($row['name']); ?></td>
                        <td><?php echo $row['recap'] ? 'Sì' : 'No'; ?></td>
                        <td class="text-right total"><?php echo $this->currencyForma($row['total']); ?></td>
                        <td class="text-right">
                            <a href="<?php echo $this->url('accantonaMoviment', array('action' => 'move', 'id' => $row['id'])); ?>" class="btn btn-default">
                                <span class="glyphicon glyphicon-transfer" title="Giroconto: sposta i soldi da un conto ad un'altro"></span>
                            </a>
                            <span data-href="<?php echo $this->url('accantonaAccount', array('action' => 'balance', 'id' => $row['id'])); ?>" class="btn btn-default balance">
                                <span class="glyphicon glyphicon-equalizer" title="Il conguaglio adegua il conto all'importo indicato"></span>
                            </span>
                            <a href="<?php echo $this->url('accantonaMoviment', array('action' => 'account', 'id' => $row['id'])); ?>" class="btn btn-default">
                                <span class="glyphicon glyphicon-list" aria-hidden="true" title="Movimenti"></span>
                            </a>
                            <a href="<?php echo $this->url('accantonaAccount', array('action' => 'edit', 'id' => $row['id'])); ?>" class="btn btn-default">
                                <span class="glyphicon glyphicon-edit" aria-hidden="true" title="Modifica"></span>
                            </a>
                            <span data-href="<?php echo $this->url('accantonaAccount', array('action' => 'delete', 'id' => $row['id'])); ?>" class="btn btn-default delete-item">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true" title="Elimina"></span>
                            </span>
                        </td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Totale</strong></td>
                        <td></td>
                        <td class="text-right"><strong><?php echo $this->currencyForma($total); ?></strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    </div>
    <div class="col-lg-3 col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">Ripartizione conti</div>
            <div id="donut-accounts"></div>
        </div>
    </div>
    <?php else: ?>
    <div class="col-lg-12">
        <i>Nessun conto definito, clicca sul tasto Aggiungi per crearne uno.</i>
    </div>
    <?php endif; ?>
</div>
<?php if ($dataChart): ?>
<?php endif; ?>
<script type="text/javascript">
    $(document).on("click", ".delete-item", function(e) {
        var button = $(this);

        var html = '<h3>Cancellare il conto selezionato?</h3>' +
            '<dl class="dl-horizontal">' +
            '<dt>Nome</dt><dd>'  + button.parents('tr').find('.name').html() + '</dd>' +
            '<dt>Saldo</dt><dd>'  + button.parents('tr').find('.total').html() + '</dd>' +
            '</dl>' +
            '<div class="alert alert-danger">' +
            '<strong>Attenzione!</strong> Eliminando il conto saranno cancellati tutti i movimenti associati e non sarà più possibile recuperarli.' +
            '</div>';
        bootbox.confirm(html, function(result) {
            if (result) {
                var form = document.createElement("form");
                form.setAttribute("method", 'post');
                form.setAttribute("action", button.data('href'));
                document.body.appendChild(form);
                form.submit();
            }
        });
    });
    $(document).ready(function(){
        $('#my-table').DataTable({
            "columnDefs": [
                {"targets": 2, "type": 'currency-it'},  // saldo
                {"orderable": false, "targets": -1}     // azioni
            ],
            "language":{
                "url": "/js/data-table-Italian.json"
            },
            "order": [
                [0, "desc"]
            ],
            "responsive": true,
            "searching": false
        });
    });
</script>
<?php
$this->morris()->donut('donut-accounts', $dataChart, 0, 1);
$this->floatingButtons()->addAnchorItem(array(
    'href' => $this->url('accantonaAccount', array('action' => 'add')),
    'label' => 'Aggiungi un conto',
    'icon' => 'plus'
));